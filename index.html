<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Stab in the Dark 2017 | Contest Results</title>
  <meta name="author" content="Stab Magazine">
  <meta name="description" content="Stab in the Dark 2017 Contest">
  <meta name="keywords" content="stabmag, stab, magazine, surfing, surfboards, jordy, smith">
  <!-- <link rel="shortcut icon" href="favicon.ico" type="image/vnd.microsoft.icon"> -->
  <link href="static/css/style.css" type="text/css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css?family=PT+Serif|Roboto:500,700" rel="stylesheet">
  <script src="https://use.fontawesome.com/9aa665cf7f.js"></script>
  </head>
  <body>


  <div class="page" data-email="">


    <div class="navigation">
      <div class="navigation__left">
        <div class="logo-bg"><img src="/static/img/StabLogoWhite.png" /></div>
        <div class="site-title">STAB x VONU COMPETITION</div>
      </div>
      <div class="navigation__right">
        <a href="/"><div class="site-title"></div></a>
        <a href="/southern-hemi"><div class="site-title" style="opacity:0.3"></div></a>
        <!-- <a href="/shared-list"><div class="site-title" style="opacity:0.3">SOCIAL SHARING</div></a> -->
      </div>
      <div id="mobile-nav" class="mobile-nav d-none"><i class="fa fa-bars"></i></div>
      <div id="mobile-menu" class="mobile-menu d-none">
        <a href="/"><div class="site-title"></div></a>
        <a href="/southern-hemi"><div class="site-title" style="opacity:0.3"></div></a>
        <!-- <a href="/shared-list"><div class="site-title" style="opacity:0.3">SOCIAL SHARING</div></a> -->
      </div>
    </div>

    <div id="shaper" class="container d-none">

      <div class="shaper-header" style="padding-bottom:12px;">
        <div>
          <div id="shaperName" class="page-title"></div>
          <div class="back-button"><i class="fa fa-long-arrow-left"></i> <span>BACK TO ISLANDS</span></div>
        </div>
        <div id="shaperCount" class="page-title"></div>
      </div>

    <div id="shaper-entries" class="shaper-entries" ></div>
    <div class="add-to-list">
      <div style="width:75%">
      <input id="list_email" placeholder="Email" type="text" />
      <input id="list_social" placeholder="Social Handle" type="text" />
      </div>
      <a id="list_add" href="#">Add To List</a>
    </div>

    <div class="button-container">
      <button id="btnDrawWinner">Draw Winner</button>
      <div id="winnerEmail" class="winner"></div>
    </div>

    </div>

    <div id="shapers" class="container">

      <div class="page-title">Stab x Vonu Competition</div>
      <div class="page-subtitle" >Select an island to view reader selection list and draw a winner.</div>

      <div class="results">

        <div class="result">
          <div data-name="Island 1" class="result__name">Island 1</div>
          <div class="result__line"></div>
          <div id="island1" class="result__count"></div>
        </div>

        <div class="result">
          <div data-name="Island 2" class="result__name">Island 2</div>
          <div class="result__line"></div>
          <div id="island2" class="result__count"></div>
        </div>

        <div class="result">
          <div data-name="Island 3" class="result__name">Island 3</div>
          <div class="result__line"></div>
          <div id="island3" class="result__count"></div>
        </div>

        <div class="result">
          <div data-name="Island 4" class="result__name">Island 4</div>
          <div class="result__line"></div>
          <div id="island4" class="result__count"></div>
        </div>



      </div>



    </div>


  </div> <!-- end page -->

  <script src="https://www.gstatic.com/firebasejs/4.5.0/firebase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js"></script>
  <script>
window.addEventListener("load", function(event) {
  // TODO: On page load.. get all the current poll results, and bind changes.

  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyCEQcgkz820JhRpN9_zoxFvm0veKt0Ql1M",
    authDomain: "stab-x-vonu-competition.firebaseapp.com",
    databaseURL: "https://stab-x-vonu-competition.firebaseio.com",
    projectId: "stab-x-vonu-competition",
    storageBucket: "stab-x-vonu-competition.appspot.com",
    messagingSenderId: "770863895315"
  };
  firebase.initializeApp(config);

  document.getElementById("mobile-nav").onclick = function() {
    if ( document.getElementById("mobile-menu").classList.contains("d-none") ) {
      document.getElementById("mobile-menu").classList.remove("d-none");
    } else {
        document.getElementById("mobile-menu").classList.add("d-none");
    }
  }

  document.getElementById("list_add").onclick = function(e) {

    var email = document.getElementById("list_email").value;
    var social = document.getElementById("list_social").value;
    var timeStamp = Date.now();

    var shaper = document.getElementById("shaperName").innerHTML

    firebase.database().ref("responses/"+ shaper + "/" + timeStamp).set({email: email, social: social});

    document.getElementById("list_email").value = ""
    document.getElementById("list_social").value = ""


  }


  document.getElementById("btnDrawWinner").onclick = function() {
    // get our current list....
    var shaperName = document.getElementById("shaperName").innerHTML;
    console.log()
    if (shaperName === "Johnny Cabianca") {
      shaperName = "JohnnyC";
    }

    document.getElementById("winnerEmail").innerHTML = '...';


    firebase.database().ref('responses/' + shaperName).once('value').then(function(snapshot) {
      var entries = snapshot.val();
      var random = _.sample(entries);
      document.getElementById("winnerEmail").innerHTML = random.email;
    });


  }

  var shaper = document.getElementsByClassName("result__name");

  Array.from(shaper).forEach(function(element) {
    element.addEventListener("click", handleShaperClick);
  });

  function handleShaperClick() {

    document.getElementById("winnerEmail").innerHTML = '';
    var shaperName = this.getAttribute("data-name");

    if (shaperName === "JohnnyC") {
      document.getElementById("shaperName").innerHTML = "Johnny Cabianca";
    } else {
      document.getElementById("shaperName").innerHTML = shaperName;
    }

    var shaperEmailsRef = firebase.database().ref("responses/" + shaperName);
    shaperEmailsRef.on("value", function(snapshot) {
      document.getElementById("shaperCount").innerHTML = _.size(snapshot.val());
      var shaperEntries = document.getElementById("shaper-entries");
      shaperEntries.innerHTML = "";

      _.forEach(snapshot.val(), function(value) {
        console.log(value.email);

        var markup = `<div class="shaper-entry shaper-entry--list"> <div class="email-entry">${value.email}</div><div class="email-entry">${value.social}</div></div>`;
        shaperEntries.innerHTML += markup;
      });
    });

    document.getElementById("shaper").classList.remove("d-none");
    document.getElementById("shapers").classList.add("d-none");
  }

  getCurrentPollData();
  function getCurrentPollData() {

    var islandOneRef = firebase.database().ref("responses/Island 1");
    islandOneRef.on("value", function(snapshot) {
      var islandOneCount = _.size(snapshot.val());
      document.getElementById("island1").innerHTML = islandOneCount;
    });

    var islandTwoRef = firebase.database().ref("responses/Island 2");
    islandTwoRef.on("value", function(snapshot) {
      var islandTwoCount = _.size(snapshot.val());
      document.getElementById("island2").innerHTML = islandTwoCount;
    });

    var islandThreeRef = firebase.database().ref("responses/Island 3");
    islandThreeRef.on("value", function(snapshot) {
      var islandThreeCount = _.size(snapshot.val());
      document.getElementById("island3").innerHTML = islandThreeCount;
    });

    var islandFourRef = firebase.database().ref("responses/Island 4");
    islandFourRef.on("value", function(snapshot) {
      var islandFourCount = _.size(snapshot.val());
      document.getElementById("island4").innerHTML = islandFourCount;
    });


  }

  var backButton = document.getElementsByClassName("back-button")[0];
  backButton.onclick = function() {
    var shaperEntries = document.getElementById("shaper-entries");
    shaperEntries.innerHTML = "";

    document.getElementById("shaper").classList.add("d-none");
    document.getElementById("shapers").classList.remove("d-none");
  };
});
</script>


  </body>
</html>
